pipeline {
  agent any  // Changed from docker agent

  environment {
    REGISTRY = "milindpatle12"
    IMAGE = "${REGISTRY}/bank-frontend:${BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
  stage('Setup Docker') {
      steps {
        script {
          // Try to install Docker if not available
          sh '''
            #!/bin/bash
            if ! command -v docker &> /dev/null; then
              echo "Docker not found. To install:"
              echo "sudo apt-get update && sudo apt-get install -y docker.io"
              echo "sudo systemctl start docker"
              exit 0  # Don't fail, just continue
            fi
            docker --version
          '''
        }
      }
    }


    stage('Build Info') {
      steps {
        sh """
          echo "ğŸ“¦ Image to build: ${IMAGE}"
          echo "ğŸ“ Deployment file: k8s/gitops/base/frontend/deployment.yaml"
        """
      }
    }

    stage('Update GitOps Manifests') {
      steps {
        sh """
          echo "ğŸ”„ Updating frontend manifests..."
          
          # Update frontend deployment.yaml
          cd k8s/gitops/base/frontend
          
          # Update image tag
          sed -i "s|image: milindpatle12/bank-frontend:.*|image: milindpatle12/bank-frontend:${BUILD_NUMBER}|g" deployment.yaml
          
          echo "âœ… Updated frontend to tag: ${BUILD_NUMBER}"
          
          cd ../../../../..
        """
      }
    }
  }
}
