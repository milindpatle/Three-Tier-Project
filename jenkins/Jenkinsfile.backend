pipeline {
  agent any

  environment {
    REGISTRY = "milindpatle12"
    IMAGE = "${REGISTRY}/bank-backend:${BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    
    stage('Setup Docker') {
      steps {
        script {
          sh '''
            #!/bin/bash
            if ! command -v docker &> /dev/null; then
              echo "âš ï¸ Docker not found. To install:"
              echo "sudo apt-get update && sudo apt-get install -y docker.io"
              echo "sudo systemctl start docker"
              echo "Note: Docker build will be skipped for now"
            else
              echo "âœ… Docker is available:"
              docker --version
            fi
          '''
        }
      }
    }

    stage('Build Info') {
      steps {
        sh """
          echo "ğŸ“¦ Image to build: ${IMAGE}"
          echo "ğŸ“ Deployment file: k8s/gitops/base/backend/deployment.yaml"
          echo "ğŸ”§ Build command would be: docker build -t ${IMAGE} ./backend"
        """
      }
    }

    stage('Update GitOps Manifests') {
      steps {
        sh """
          echo "ğŸ”„ Updating GitOps manifests..."
          
          # Navigate to the correct directory
          cd k8s/gitops/base/backend
          
          echo "ğŸ“„ Current deployment.yaml content:"
          cat deployment.yaml
          
          # Update image tag from latest to BUILD_NUMBER
          sed -i "s|image: milindpatle12/bank-backend:.*|image: milindpatle12/bank-backend:${BUILD_NUMBER}|g" deployment.yaml
          
          echo "âœ… Updated deployment.yaml with tag: ${BUILD_NUMBER}"
          echo "ğŸ“„ Updated content:"
          cat deployment.yaml
          
          # Go back to root
          cd ../../../../..
        """
      }
    }
    
    stage('Commit Changes') {
      steps {
        sh """
          echo "ğŸ’¾ Committing changes..."
          
          git config user.email "jenkins@local"
          git config user.name "jenkins"
          
          # Add the updated file
          git add k8s/gitops/base/backend/deployment.yaml
          
          # Commit
          git commit -m "CI: Update backend image to v${BUILD_NUMBER}" || echo "No changes to commit"
          
          # Push (optional - remove # to enable)
          # git push origin main || echo "Push failed or not configured"
          
          echo "âœ… Changes committed!"
          echo "ğŸ“Œ Image: milindpatle12/bank-backend:${BUILD_NUMBER}"
          echo "ğŸ“ File: k8s/gitops/base/backend/deployment.yaml"
        """
      }
    }
  }
  
  post {
    always {
      echo "ğŸ Pipeline finished"
    }
    success {
      echo "ğŸ‰ SUCCESS: Backend pipeline completed!"
      echo "ğŸ“¦ Image: milindpatle12/bank-backend:${BUILD_NUMBER}"
      echo "ğŸ“ Updated: k8s/gitops/base/backend/deployment.yaml"
    }
    failure {
      echo "âŒ FAILURE: Pipeline failed"
    }
  }
}